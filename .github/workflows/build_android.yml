name: Build Qt for Android
on:
  push:
    branches:
      - main
      - android_build
    tags:
      - v*

jobs:
  build:
    runs-on: ubuntu-20.04
    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_ROOT: ${{ github.workspace }}/android-sdk/ndk/21.3.6528147
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4
      
      - name: Make build script executable
        run: chmod +x build_android.sh install_dependencies.sh

      - name: Install Dependencies
        run: ./install_dependencies.sh

      - name: Android SDK & NDK einrichten
        run: |
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT/cmdline-tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          mkdir -p latest
          unzip -q cmdline-tools.zip -d latest
          rm cmdline-tools.zip
          if [ -d latest/cmdline-tools ]; then
            mv latest/cmdline-tools/* latest/
            rmdir latest/cmdline-tools
          fi
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT --update
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;android-29" "build-tools;29.0.2" "ndk;21.3.6528147"

      - name: Exportiere Umgebungsvariablen
        run: |
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "JAVA_HOME=$JAVA_HOME/bin" >> $GITHUB_ENV

      - name: Qt-Quellcode klonen und Version 5.15.16 auschecken
        run: |
          git clone --branch v5.15.16-lts-lgpl https://invent.kde.org/qt/qt/qt5.git
          cd qt5
          perl init-repository

      - name: Qt für Android konfigurieren
        run: |
          cd qt5
          mkdir build-android && cd build-android
          ../configure -xplatform android-clang \
            --disable-rpath \
            -android-ndk $ANDROID_NDK_ROOT \
            -android-sdk $ANDROID_SDK_ROOT \
            -android-ndk-host linux-x86_64 \
            -android-abis armeabi-v7a,arm64-v8a \
            -prefix $GITHUB_WORKSPACE/Qt5.15.16/android \
            -no-warnings-are-errors \
            -nomake examples -nomake tests \
            -opensource -confirm-license \
            -ltcg \
            -use-llvm \
            -optimize-size

      - name: Qt für Android bauen
        run: |
          cd qt5/build-android
          make -j$(nproc)

      - name: Qt für Android installieren
        run: |
          cd qt5/build-android
          sudo make install
          - name: "Archive Build"
          uses: actions/upload-artifact@v4
          with:
            name: Archive Build
            path: $GITHUB_WORKSPACE/Qt5.15.16/android
  
      - name: "Tar Build"
        run: tar -czvf Qt-5.15-16-android.tar.gz -C $GITHUB_WORKSPACE/Qt5.15.16/android .

      - name: "Upload Build to release"
        if: github.ref_type == 'tag'
        uses: svenstaro/upload-release-action@v2
        with:
          file: Qt-5.15-16-android.tar.gz
          tag: ${{ github.ref }}
          overwrite: true
